# OpenClaw - One-Click Deployment for Coolify
# https://github.com/openclaw/openclaw
#
# Deploy your own personal AI assistant with WhatsApp, Telegram, Discord,
# and WebChat integration.
#
# Quick Start:
# 1. Copy .env.example to .env and configure your settings
# 2. Deploy via Coolify using Docker Compose build pack
# 3. Access Control UI at your domain and enter gateway token
# 4. Configure channels (WhatsApp QR, Telegram token, etc.)

services:
  # =============================================================================
  # OPENCLAW GATEWAY - Main AI Assistant Service
  # =============================================================================
  openclaw-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    image: openclaw-gateway:${OPENCLAW_VERSION:-latest}
    container_name: openclaw-gateway
    restart: unless-stopped

    environment:
      # === Core Settings ===
      - NODE_ENV=production
      - HOME=/home/openclaw
      - TERM=xterm-256color

      # === Gateway Configuration ===
      - OPENCLAW_GATEWAY_BIND=${OPENCLAW_GATEWAY_BIND:-lan}
      - OPENCLAW_GATEWAY_PORT=${OPENCLAW_GATEWAY_PORT:-18789}
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN:-}

      # === Data Paths ===
      - OPENCLAW_CONFIG_PATH=/data/.openclaw/openclaw.json
      - OPENCLAW_STATE_DIR=/data/.openclaw
      - XDG_CONFIG_HOME=/data/.openclaw

      # === Model Authentication ===
      # Set at least one of these for the AI to work
      # API Keys (direct):
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      # Claude OAuth (alternative to API key - paste from 'claude setup-token'):
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN:-}
      # OpenRouter (access many models with one key):
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}

      # === Channel: Telegram ===
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}

      # === Channel: Discord ===
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN:-}

      # === Channel: Slack ===
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - SLACK_APP_TOKEN=${SLACK_APP_TOKEN:-}

      # === Browser Integration ===
      - OPENCLAW_BROWSER_ENABLED=${OPENCLAW_BROWSER_ENABLED:-true}
      - OPENCLAW_BROWSER_URL=http://openclaw-browser:9222

      # === Redis Cache ===
      - REDIS_URL=${REDIS_URL:-redis://openclaw-redis:6379}

      # === Gmail Integration (optional) ===
      - GOG_KEYRING_PASSWORD=${GOG_KEYRING_PASSWORD:-}

      # === Web Search (optional) ===
      - BRAVE_SEARCH_API_KEY=${BRAVE_SEARCH_API_KEY:-}

      # === Optional Integrations ===
      - GOOGLE_PLACES_API_KEY=${GOOGLE_PLACES_API_KEY:-}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY:-}

    volumes:
      # Persistent storage for config, credentials, and sessions
      - openclaw-config:/data/.openclaw
      # Agent workspace for code and artifacts
      - openclaw-workspace:/data/openclaw

    ports:
      # Gateway WebSocket + Control UI
      - "${OPENCLAW_GATEWAY_PORT:-18789}:18789"
      # Canvas host (optional, for mobile nodes)
      - "${OPENCLAW_CANVAS_PORT:-18793}:18793"

    depends_on:
      openclaw-redis:
        condition: service_healthy
      openclaw-browser:
        condition: service_started

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:18789/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

    networks:
      - openclaw-network

  # =============================================================================
  # REDIS - Cache and Session Storage
  # =============================================================================
  openclaw-redis:
    image: redis:7-alpine
    container_name: openclaw-redis
    restart: unless-stopped

    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru

    volumes:
      - openclaw-redis-data:/data

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

    networks:
      - openclaw-network

  # =============================================================================
  # BROWSER - Chromium for Browser Automation Tool
  # =============================================================================
  openclaw-browser:
    image: chromedp/headless-shell:latest
    container_name: openclaw-browser
    restart: unless-stopped

    # Shared memory for Chrome
    shm_size: 2gb

    # Chrome runs with --remote-debugging-port=9222 by default
    # No healthcheck needed - chromedp/headless-shell is minimal

    networks:
      - openclaw-network

# =============================================================================
# VOLUMES - Persistent Storage
# =============================================================================
volumes:
  openclaw-config:
    name: openclaw-config
  openclaw-workspace:
    name: openclaw-workspace
  openclaw-redis-data:
    name: openclaw-redis-data

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  openclaw-network:
    driver: bridge
